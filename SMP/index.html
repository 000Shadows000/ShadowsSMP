<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ranking Shadows SMP</title>

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div class="header-logos">
      <img src="logo.png" alt="Shadows SMP" class="logo">
      <img src="ranking.png" alt="Ranking" class="ranking">
    </div>
  </header>

  <main>
    <table id="rankingTable" aria-describedby="ranking-description">
      <caption id="ranking-description" style="display:none">Ranking de jugadores</caption>
      <thead>
        <tr>
          <th>Skin</th>
          <th>Jugador</th>
          <th>Construcción</th>
          <th>Técnico</th>
          <th>PvP</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <footer>
    <p>© 2025 Shadows SMP</p>
  </footer>

  <!-- MODAL -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="playerName">
      <span class="close" aria-label="Cerrar">&times;</span>

      <div class="modal-left">
        <h2 id="playerName" style="margin:0;color:#fff;"></h2>
        <img id="playerBody" class="player-body" src="" alt="Cuerpo del jugador">
      </div>

      <div class="modal-right">
        <div class="chart-wrap">
          <canvas id="statsChart"></canvas>
        </div>
        <div id="statsValues" class="stats-values"></div>
      </div>
    </div>
  </div>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    let chartInstance = null;

    // Cargar jugadores y calcular total
    async function cargarJugadores() {
      const response = await fetch("jugadores.json");
      const jugadores = await response.json();

      const tbody = document.querySelector("#rankingTable tbody");
      tbody.innerHTML = "";

      jugadores.forEach(j => {
        j.total = (j.pvp || 0) + (j.construccion || 0) + (j.tecnico || 0);

        const fila = document.createElement("tr");
        const skin = `https://mc-heads.net/avatar/${encodeURIComponent(j.nombre)}.png?overlay`;
        const cuerpo = `https://mc-heads.net/body/${encodeURIComponent(j.nombre)}.png`;

        const tdImg = document.createElement("td");
        const img = document.createElement("img");
        img.src = skin;
        img.alt = j.nombre;
        img.className = "skin";
        img.onerror = () => { img.src = "steve.png"; };
        tdImg.appendChild(img);

        fila.appendChild(tdImg);
        fila.innerHTML += `
          <td class="jugador-nombre">${escapeHtml(j.nombre)}</td>
          <td>${Number(j.construccion || 0)}</td>
          <td>${Number(j.tecnico || 0)}</td>
          <td>${Number(j.pvp || 0)}</td>
          <td>${Number(j.total)}</td>
        `;

        fila.addEventListener("click", () => abrirModal(j, cuerpo));
        tbody.appendChild(fila);
      });

      ordenarTabla();
    }

    function ordenarTabla() {
      const table = document.getElementById("rankingTable").tBodies[0];
      const rows = Array.from(table.rows);

      rows.sort((a, b) => {
        const A = parseInt(a.cells[5].innerText);
        const B = parseInt(b.cells[5].innerText);
        return B - A;
      });

      rows.forEach((r, i) => {
        r.classList.remove("top1", "top2", "top3");
        if (i === 0) r.classList.add("top1");
        else if (i === 1) r.classList.add("top2");
        else if (i === 2) r.classList.add("top3");
        table.appendChild(r);
      });
    }

    function abrirModal(jugador, cuerpoURL) {
      const modal = document.getElementById("modal");
      const nameEl = document.getElementById("playerName");
      const bodyEl = document.getElementById("playerBody");
      const statsValues = document.getElementById("statsValues");
      const ctx = document.getElementById("statsChart");

      nameEl.textContent = jugador.nombre;
      bodyEl.src = cuerpoURL;
      bodyEl.onerror = () => { bodyEl.src = "steve.png"; };

      jugador.total = (jugador.pvp || 0) + (jugador.construccion || 0) + (jugador.tecnico || 0);

      const stats = [
        Number(jugador.potencial || 0),
        Number(jugador.precision || 0),
        Number(jugador.adaptabilidad || 0),
        Number(jugador.pvp || 0),
        Number(jugador.construccion || 0),
        Number(jugador.tecnico || 0)
      ];
      const labels = ["Potencial", "Precisión", "Adaptabilidad", "PvP", "Construcción", "Técnico"];

      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }

      chartInstance = new Chart(ctx, {
        type: "radar",
        data: {
          labels,
          datasets: [{
            label: "Estadísticas",
            data: stats,
            backgroundColor: "rgba(121,51,171,0.35)",
            borderColor: "#b200ff",
            borderWidth: 2,
            pointBackgroundColor: "#b200ff",
            pointRadius: 5,
            pointHoverRadius: 8,
            pointHoverBackgroundColor: "#fff"
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              angleLines: { color: "#333" },
              grid: { color: "#444" },
              pointLabels: { color: "#ccc", font: { size: 12 } },
              ticks: { display: false, beginAtZero: true, max: 100 }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              backgroundColor: "rgba(0,0,0,0.85)",
              borderColor: "#b200ff",
              borderWidth: 1,
              titleFont: { size: 13, weight: "bold" },
              bodyFont: { size: 12 },
              displayColors: false,
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.formattedValue}`;
                }
              }
            }
          },
          elements: { point: { radius: 5, hoverRadius: 8 } }
        }
      });

      statsValues.innerHTML = `
        <p><b>Potencial:</b> ${stats[0]}</p>
        <p><b>Precisión:</b> ${stats[1]}</p>
        <p><b>Adaptabilidad:</b> ${stats[2]}</p>
        <p><b>PvP:</b> ${stats[3]}</p>
        <p><b>Construcción:</b> ${stats[4]}</p>
        <p><b>Técnico:</b> ${stats[5]}</p>
        <p style="margin-top:8px;"><b>Total (PvP+Construcción+Técnico):</b> ${jugador.total}</p>
      `;

      modal.style.display = "flex";
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      // Forzar re-render preciso
      requestAnimationFrame(() => {
        if (chartInstance) {
          chartInstance.resize();
          chartInstance.update();
        }
      });
    }

    function cerrarModal() {
      const modal = document.getElementById("modal");
      modal.style.display = "none";
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
    }

    document.querySelector(".close").onclick = cerrarModal;
    window.onclick = e => { if (e.target === document.getElementById("modal")) cerrarModal(); };

    function escapeHtml(text) {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    window.onload = cargarJugadores;
  </script>
</body>
</html>
